<head>
    <title>Orbit Controls</title>
    <script src="mindar.prod.js"></script>
    
    <style>
    </style>

    <script>

      // https://jsfiddle.net/gftruj/gez2fxk9/8/
      AFRAME.registerComponent("scaled", {
        init: function() {
          window.addEventListener("mousewheel", (e) => {
            let scaleFactor = e.deltaY > 0 ? 0.9 : 1.1
            let scale = this.el.getAttribute("scale").clone()
            scale.multiplyScalar(scaleFactor)
            this.el.setAttribute("scale", scale)
          })
        }
      })

      AFRAME.registerComponent("gesture-handler", {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 5 },
          minScale: { default: 0.3 },
          maxScale: { default: 8 },
        },

        init: function () {
          this.handleScale = this.handleScale.bind(this);
          this.handleRotation = this.handleRotation.bind(this);

          this.isVisible = false;
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;

          this.el.sceneEl.addEventListener("markerFound", (e) => {
            this.isVisible = true;
          });

          this.el.sceneEl.addEventListener("markerLost", (e) => {
            this.isVisible = false;
          });
        },

        update: function () {
          if (this.data.enabled) {
            this.el.sceneEl.addEventListener("onefingermove", this.handleRotation);
            this.el.sceneEl.addEventListener("twofingermove", this.handleScale);
          } else {
            this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
            this.el.sceneEl.removeEventListener("twofingermove", this.handleScale);
          }
        },

        remove: function () {
          this.el.sceneEl.removeEventListener("onefingermove", this.handleRotation);
          this.el.sceneEl.removeEventListener("twofingermove", this.handleScale);
        },

        handleRotation: function (event) {
          if (this.isVisible) {
            this.el.object3D.rotation.y +=
              event.detail.positionChange.x * this.data.rotationFactor;
            this.el.object3D.rotation.x +=
              event.detail.positionChange.y * this.data.rotationFactor;
          }
        },

        handleScale: function (event) {
          if (this.isVisible) {
            this.scaleFactor *=
              1 + event.detail.spreadChange / event.detail.startSpread;

            this.scaleFactor = Math.min(
              Math.max(this.scaleFactor, this.data.minScale),
              this.data.maxScale
            );

            this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
            this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
            this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
          }
        },
      });

      AFRAME.registerComponent('autoscale', {
        schema: {type: 'number', default: 1},
        init: function () {
          this.scale();
          this.el.addEventListener('object3dset', () => this.scale());
        },
        scale: function () {
          const el = this.el;
          const span = this.data;
          const mesh = el.getObject3D('mesh');

          if (!mesh) return;

          // Compute bounds.
          const bbox = new THREE.Box3().setFromObject(mesh);

          // Normalize scale.
          const scale = span / bbox.getSize().length();
          mesh.scale.set(scale, scale, scale);

          // Recenter.
          const offset = bbox.getCenter().multiplyScalar(scale);
          mesh.position.sub(offset);
        }
      });

    </script>
</head>

<body>
  <div class="example-container">
    <a-scene mindar="imageTargetSrc: ./assets/temple5/logo1.mind; showStats: true;" embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: flase">
        <a-assets>
            <img id="card" src="./assets/temple5/Marker3-01.jpg" />
            <a-asset-item id="castle" src="https://gftruj.github.io/webzamples/aframe/assets/models/sandcastle/SandCastle.gltf"></a-asset-item>
        </a-assets>

        <a-entity mindar-image-target="targetIndex: 0">
          <a-entity autoscale="1.5" id="castle" gltf-model="#castle" animation="property: object3D.rotation.y; from: 0; to: 360; dur: 10000; loop: true;" gesture-handler></a-entity>
        </a-entity>

        <a-camera camera look-controls></a-camera>
    </a-scene>
  </div>
</body>